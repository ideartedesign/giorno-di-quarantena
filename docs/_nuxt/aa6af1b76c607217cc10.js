/*! For license information please see LICENSES */
(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{194:function(e,t,r){"use strict";r.r(t),r.d(t,"FBXLoader",(function(){return $}));var n=r(165),o={},l=o;function c(e,t){var r,a=e.split("."),b=l;!(a[0]in b)&&b.execScript&&b.execScript("var "+a[0]);for(;a.length&&(r=a.shift());)a.length||void 0===t?b=b[r]?b[r]:b[r]={}:b[r]=t}var h="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function f(e){var t,r,g,n,o,l,c,p,s,f,v=e.length,a=0,b=Number.POSITIVE_INFINITY;for(p=0;p<v;++p)e[p]>a&&(a=e[p]),e[p]<b&&(b=e[p]);for(t=1<<a,r=new(h?Uint32Array:Array)(t),g=1,n=0,o=2;g<=a;){for(p=0;p<v;++p)if(e[p]===g){for(l=0,c=n,s=0;s<g;++s)l=l<<1|1&c,c>>=1;for(f=g<<16|p,s=l;s<t;s+=o)r[s]=f;++n}++g,n<<=1,o<<=1}return[r,a,b]}function v(e,t){switch(this.g=[],this.h=32768,this.d=this.f=this.a=this.l=0,this.input=h?new Uint8Array(e):e,this.m=!1,this.i=m,this.r=!1,!t&&(t={})||(t.index&&(this.a=t.index),t.bufferSize&&(this.h=t.bufferSize),t.bufferType&&(this.i=t.bufferType),t.resize&&(this.r=t.resize)),this.i){case d:this.b=32768,this.c=new(h?Uint8Array:Array)(32768+this.h+258);break;case m:this.b=0,this.c=new(h?Uint8Array:Array)(this.h),this.e=this.z,this.n=this.v,this.j=this.w;break;default:throw Error("invalid inflate mode")}}var d=0,m=1,y={t:d,s:m};v.prototype.k=function(){for(;!this.m;){var e=U(this,3);switch(1&e&&(this.m=!0),e>>>=1){case 0:var t=this.input,a=this.a,b=this.c,r=this.b,n=t.length,g=void 0,o=b.length,l=void 0;if(this.d=this.f=0,a+1>=n)throw Error("invalid uncompressed block header: LEN");if(g=t[a++]|t[a++]<<8,a+1>=n)throw Error("invalid uncompressed block header: NLEN");if(g===~(t[a++]|t[a++]<<8))throw Error("invalid uncompressed block header: length verify");if(a+g>t.length)throw Error("input buffer is broken");switch(this.i){case d:for(;r+g>b.length;){if(g-=l=o-r,h)b.set(t.subarray(a,a+l),r),r+=l,a+=l;else for(;l--;)b[r++]=t[a++];this.b=r,b=this.e(),r=this.b}break;case m:for(;r+g>b.length;)b=this.e({p:2});break;default:throw Error("invalid inflate mode")}if(h)b.set(t.subarray(a,a+g),r),r+=g,a+=g;else for(;g--;)b[r++]=t[a++];this.a=a,this.b=r,this.c=b;break;case 1:this.j(O,B);break;case 2:var c,v,y,w,I=U(this,5)+257,p=U(this,5)+1,s=U(this,4)+4,T=new(h?Uint8Array:Array)(x.length),u=void 0,A=void 0,k=void 0,E=void 0,q=void 0;for(q=0;q<s;++q)T[x[q]]=U(this,3);if(!h)for(q=s,s=T.length;q<s;++q)T[x[q]]=0;for(c=f(T),u=new(h?Uint8Array:Array)(I+p),q=0,w=I+p;q<w;)switch(A=j(this,c),A){case 16:for(E=3+U(this,2);E--;)u[q++]=k;break;case 17:for(E=3+U(this,3);E--;)u[q++]=0;k=0;break;case 18:for(E=11+U(this,7);E--;)u[q++]=0;k=0;break;default:k=u[q++]=A}v=f(h?u.subarray(0,I):u.slice(0,I)),y=f(h?u.subarray(I):u.slice(I)),this.j(v,y);break;default:throw Error("unknown BTYPE: "+e)}}return this.n()};var w,I,T=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],x=h?new Uint16Array(T):T,A=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],k=h?new Uint16Array(A):A,E=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],D=h?new Uint8Array(E):E,P=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],N=h?new Uint16Array(P):P,S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],L=h?new Uint8Array(S):S,F=new(h?Uint8Array:Array)(288);for(w=0,I=F.length;w<I;++w)F[w]=143>=w?8:255>=w?9:279>=w?7:8;var R,C,O=f(F),M=new(h?Uint8Array:Array)(30);for(R=0,C=M.length;R<C;++R)M[R]=5;var B=f(M);function U(e,t){for(var r,a=e.f,b=e.d,n=e.input,o=e.a,g=n.length;b<t;){if(o>=g)throw Error("input buffer is broken");a|=n[o++]<<b,b+=8}return r=a&(1<<t)-1,e.f=a>>>t,e.d=b-t,e.a=o,r}function j(e,t){for(var r,n,a=e.f,b=e.d,o=e.input,l=e.a,g=o.length,c=t[0],h=t[1];b<h&&!(l>=g);)a|=o[l++]<<b,b+=8;if((n=(r=c[a&(1<<h)-1])>>>16)>b)throw Error("invalid code length: "+n);return e.f=a>>n,e.d=b-n,e.a=l,65535&r}function V(e,t){var a,b;switch(this.input=e,this.a=0,!t&&(t={})||(t.index&&(this.a=t.index),t.verify&&(this.A=t.verify)),a=e[this.a++],b=e[this.a++],15&a){case z:this.method=z;break;default:throw Error("unsupported compression method")}if(0!=((a<<8)+b)%31)throw Error("invalid fcheck flag:"+((a<<8)+b)%31);if(32&b)throw Error("fdict flag is not supported");this.q=new v(e,{index:this.a,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}v.prototype.j=function(e,t){var a=this.c,b=this.b;this.o=e;for(var r,g,n,o,l=a.length-258;256!==(r=j(this,e));)if(256>r)b>=l&&(this.b=b,a=this.e(),b=this.b),a[b++]=r;else for(o=k[g=r-257],0<D[g]&&(o+=U(this,D[g])),r=j(this,t),n=N[r],0<L[r]&&(n+=U(this,L[r])),b>=l&&(this.b=b,a=this.e(),b=this.b);o--;)a[b]=a[b++-n];for(;8<=this.d;)this.d-=8,this.a--;this.b=b},v.prototype.w=function(e,t){var a=this.c,b=this.b;this.o=e;for(var r,g,n,o,l=a.length;256!==(r=j(this,e));)if(256>r)b>=l&&(l=(a=this.e()).length),a[b++]=r;else for(o=k[g=r-257],0<D[g]&&(o+=U(this,D[g])),r=j(this,t),n=N[r],0<L[r]&&(n+=U(this,L[r])),b+o>l&&(l=(a=this.e()).length);o--;)a[b]=a[b++-n];for(;8<=this.d;)this.d-=8,this.a--;this.b=b},v.prototype.e=function(){var a,b,e=new(h?Uint8Array:Array)(this.b-32768),t=this.b-32768,r=this.c;if(h)e.set(r.subarray(32768,e.length));else for(a=0,b=e.length;a<b;++a)e[a]=r[a+32768];if(this.g.push(e),this.l+=e.length,h)r.set(r.subarray(t,t+32768));else for(a=0;32768>a;++a)r[a]=r[t+a];return this.b=32768,r},v.prototype.z=function(e){var t,r,n,a=this.input.length/this.a+1|0,g=this.input,o=this.c;return e&&("number"==typeof e.p&&(a=e.p),"number"==typeof e.u&&(a+=e.u)),2>a?r=(n=(g.length-this.a)/this.o[2]/2*258|0)<o.length?o.length+n:o.length<<1:r=o.length*a,h?(t=new Uint8Array(r)).set(o):t=o,this.c=t},v.prototype.n=function(){var b,e,g,t,r,n=0,o=this.c,a=this.g,l=new(h?Uint8Array:Array)(this.l+(this.b-32768));if(0===a.length)return h?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);for(e=0,g=a.length;e<g;++e)for(t=0,r=(b=a[e]).length;t<r;++t)l[n++]=b[t];for(e=32768,g=this.b;e<g;++e)l[n++]=o[e];return this.g=[],this.buffer=l},v.prototype.v=function(){var e,t=this.b;return h?this.r?(e=new Uint8Array(t)).set(this.c.subarray(0,t)):e=this.c.subarray(0,t):(this.c.length>t&&(this.c.length=t),e=this.c),this.buffer=e},V.prototype.k=function(){var e,a,t=this.input;if(e=this.q.k(),this.a=this.q.a,this.A){a=(t[this.a++]<<24|t[this.a++]<<16|t[this.a++]<<8|t[this.a++])>>>0;var b=e;if("string"==typeof b){var r,g,n=b.split("");for(r=0,g=n.length;r<g;r++)n[r]=(255&n[r].charCodeAt(0))>>>0;b=n}for(var o,l=1,c=0,h=b.length,p=0;0<h;){h-=o=1024<h?1024:h;do{c+=l+=b[p++]}while(--o);l%=65521,c%=65521}if(a!==(c<<16|l)>>>0)throw Error("invalid adler-32 checksum")}return e};var z=8;c("Zlib.Inflate",V),c("Zlib.Inflate.prototype.decompress",V.prototype.k);var X,G,W,H,_={ADAPTIVE:y.s,BLOCK:y.t};if(Object.keys)X=Object.keys(_);else for(G in X=[],W=0,_)X[W++]=G;for(W=0,H=X.length;W<H;++W)c("Zlib.Inflate.BufferType."+(G=X[W]),_[G]);var Z=o.Zlib,K={findSpan:function(p,u,e){var t=e.length-p-1;if(u>=e[t])return t-1;if(u<=e[p])return p;for(var r=p,n=t,o=Math.floor((r+n)/2);u<e[o]||u>=e[o+1];)u<e[o]?n=o:r=o,o=Math.floor((r+n)/2);return o},calcBasisFunctions:function(span,u,p,e){var t=[],r=[],n=[];t[0]=1;for(var o=1;o<=p;++o){r[o]=u-e[span+1-o],n[o]=e[span+o]-u;for(var l=0,c=0;c<o;++c){var h=n[c+1],f=r[o-c],v=t[c]/(h+f);t[c]=l+h*v,l=f*v}t[o]=l}return t},calcBSplinePoint:function(p,e,t,u){for(var span=this.findSpan(p,u,e),r=this.calcBasisFunctions(span,u,p,e),o=new n.W(0,0,0,0),l=0;l<=p;++l){var c=t[span-p+l],h=r[l],f=c.w*h;o.x+=c.x*f,o.y+=c.y*f,o.z+=c.z*f,o.w+=c.w*h}return o},calcBasisFunctionDerivatives:function(span,u,p,e,t){for(var r=[],i=0;i<=p;++i)r[i]=0;var n=[];for(i=0;i<=e;++i)n[i]=r.slice(0);var o=[];for(i=0;i<=p;++i)o[i]=r.slice(0);o[0][0]=1;for(var l=r.slice(0),c=r.slice(0),h=1;h<=p;++h){l[h]=u-t[span+1-h],c[h]=t[span+h]-u;for(var f=0,v=0;v<h;++v){var d=c[v+1],m=l[h-v];o[h][v]=d+m;var y=o[v][h-1]/o[h][v];o[v][h]=f+d*y,f=m*y}o[h][h]=f}for(h=0;h<=p;++h)n[0][h]=o[h][p];for(v=0;v<=p;++v){var w=0,I=1,a=[];for(i=0;i<=p;++i)a[i]=r.slice(0);a[0][0]=1;for(var T=1;T<=e;++T){var x=0,A=v-T,k=p-T;v>=T&&(a[I][0]=a[w][0]/o[k+1][A],x=a[I][0]*o[A][k]);var E=v-1<=k?T-1:p-v;for(h=A>=-1?1:-A;h<=E;++h)a[I][h]=(a[w][h]-a[w][h-1])/o[k+1][A+h],x+=a[I][h]*o[A+h][k];v<=k&&(a[I][T]=-a[w][T-1]/o[k+1][v],x+=a[I][T]*o[v][k]),n[T][v]=x;h=w;w=I,I=h}}for(v=p,T=1;T<=e;++T){for(h=0;h<=p;++h)n[T][h]*=v;v*=p-T}return n},calcBSplineDerivatives:function(p,e,t,u,r){for(var o=r<p?r:p,l=[],span=this.findSpan(p,u,e),c=this.calcBasisFunctionDerivatives(span,u,p,o,e),h=[],i=0;i<t.length;++i){var f=(d=t[i].clone()).w;d.x*=f,d.y*=f,d.z*=f,h[i]=d}for(var v=0;v<=o;++v){for(var d=h[span-p].clone().multiplyScalar(c[v][0]),m=1;m<=p;++m)d.add(h[span-p+m].clone().multiplyScalar(c[v][m]));l[v]=d}for(v=o+1;v<=r+1;++v)l[v]=new n.W(0,0,0);return l},calcKoverI:function(e,i){for(var t=1,r=2;r<=e;++r)t*=r;var n=1;for(r=2;r<=i;++r)n*=r;for(r=2;r<=e-i;++r)n*=r;return t/n},calcRationalCurveDerivatives:function(e){for(var t=e.length,r=[],o=[],i=0;i<t;++i){var l=e[i];r[i]=new n.V(l.x,l.y,l.z),o[i]=l.w}for(var c=[],h=0;h<t;++h){var f=r[h].clone();for(i=1;i<=h;++i)f.sub(c[h-i].clone().multiplyScalar(this.calcKoverI(h,i)*o[i]));c[h]=f.divideScalar(o[0])}return c},calcNURBSDerivatives:function(p,e,t,u,r){var n=this.calcBSplineDerivatives(p,e,t,u,r);return this.calcRationalCurveDerivatives(n)},calcSurfacePoint:function(p,q,e,t,r,u,o,l){for(var c=this.findSpan(p,u,e),h=this.findSpan(q,o,t),f=this.calcBasisFunctions(c,u,p,e),v=this.calcBasisFunctions(h,o,q,t),d=[],m=0;m<=q;++m){d[m]=new n.W(0,0,0,0);for(var y=0;y<=p;++y){var w=r[c-p+y][h-q+m].clone(),I=w.w;w.x*=I,w.y*=I,w.z*=I,d[m].add(w.multiplyScalar(f[y]))}}var T=new n.W(0,0,0,0);for(m=0;m<=q;++m)T.add(d[m].multiplyScalar(v[m]));T.divideScalar(T.w),l.set(T.x,T.y,T.z)}},Y=function(e,t,r,o,l){n.h.call(this),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=o||0,this.endKnot=l||this.knots.length-1;for(var i=0;i<r.length;++i){var c=r[i];this.controlPoints[i]=new n.W(c.x,c.y,c.z,c.w)}};(Y.prototype=Object.create(n.h.prototype)).constructor=Y,Y.prototype.getPoint=function(e){var u=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),t=K.calcBSplinePoint(this.degree,this.knots,this.controlPoints,u);return 1!=t.w&&t.divideScalar(t.w),new n.V(t.x,t.y,t.z)},Y.prototype.getTangent=function(e){var u=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),t=K.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,u,1)[1].clone();return t.normalize(),t};var $=function(){var e,t,r;function o(e){n.r.call(this,e)}function l(e,t){this.textureLoader=e,this.manager=t}function c(){}function h(){}function f(){}function v(){}function d(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function m(){}function y(text){var e=text.match(/FBXVersion: (\d+)/);if(e)return parseInt(e[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function w(time){return time/46186158e3}o.prototype=Object.assign(Object.create(n.r.prototype),{constructor:o,load:function(e,t,r,o){var l=this,path=""===l.path?n.s.extractUrlBase(e):l.path,c=new n.m(this.manager);c.setPath(l.path),c.setResponseType("arraybuffer"),c.load(e,(function(r){try{t(l.parse(r,path))}catch(t){setTimeout((function(){o&&o(t),l.manager.itemError(e)}),0)}}),r,o)},parse:function(t,path){if(c="Kaydara FBX Binary  \0",(o=t).byteLength>=c.length&&c===P(o,0,c.length))e=(new v).parse(t);else{var r=P(t);if(!function(text){var e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],cursor=0;for(var i=0;i<e.length;++i){if((r=void 0,r=text[(t=1)-1],text=text.slice(cursor+t),cursor++,r)===e[i])return!1}var t,r;return!0}(r))throw new Error("THREE.FBXLoader: Unknown format.");if(y(r)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+y(r));e=(new f).parse(r)}var o,c;return new l(new n.S(this.manager).setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin),this.manager).parse(e)}}),l.prototype={constructor:l,parse:function(){t=this.parseConnections();var e=this.parseImages(),n=this.parseTextures(e),o=this.parseMaterials(n),l=this.parseDeformers(),h=(new c).parse(l);return this.parseScene(l,h,o),r},parseConnections:function(){var t=new Map;"Connections"in e&&e.Connections.connections.forEach((function(e){var r=e[0],n=e[1],o=e[2];t.has(r)||t.set(r,{parents:[],children:[]});var l={ID:n,relationship:o};t.get(r).parents.push(l),t.has(n)||t.set(n,{parents:[],children:[]});var c={ID:r,relationship:o};t.get(n).children.push(c)}));return t},parseImages:function(){var t={},r={};if("Video"in e.Objects){var n=e.Objects.Video;for(var o in n){var l=n[o];if(t[f=parseInt(o)]=l.RelativeFilename||l.Filename,"Content"in l){var c=l.Content instanceof ArrayBuffer&&l.Content.byteLength>0,h="string"==typeof l.Content&&""!==l.Content;if(c||h){var image=this.parseImage(n[o]);r[l.RelativeFilename||l.Filename]=image}}}}for(var f in t){var v=t[f];void 0!==r[v]?t[f]=r[v]:t[f]=t[f].split("\\").pop()}return t},parseImage:function(e){var t,content=e.Content,r=e.RelativeFilename||e.Filename,n=r.slice(r.lastIndexOf(".")+1).toLowerCase();switch(n){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",r),t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+n+'" is not supported.')}if("string"==typeof content)return"data:"+t+";base64,"+content;var o=new Uint8Array(content);return window.URL.createObjectURL(new Blob([o],{type:t}))},parseTextures:function(t){var r=new Map;if("Texture"in e.Objects){var n=e.Objects.Texture;for(var o in n){var l=this.parseTexture(n[o],t);r.set(parseInt(o),l)}}return r},parseTexture:function(e,t){var r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;var o=e.WrapModeU,l=e.WrapModeV,c=void 0!==o?o.value:0,h=void 0!==l?l.value:0;if(r.wrapS=0===c?n.J:n.f,r.wrapT=0===h?n.J:n.f,"Scaling"in e){var f=e.Scaling.value;r.repeat.x=f[0],r.repeat.y=f[1]}return r},loadTexture:function(e,r){var o,l,c=this.textureLoader.path,h=t.get(e.id).children;void 0!==h&&h.length>0&&void 0!==r[h[0].ID]&&(0!==(o=r[h[0].ID]).indexOf("blob:")&&0!==o.indexOf("data:")||this.textureLoader.setPath(void 0));var f=e.FileName.slice(-3).toLowerCase();if("tga"===f){var v=this.manager.getHandler(".tga");null===v?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),l=new n.R):l=v.load(o)}else"psd"===f?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),l=new n.R):l=this.textureLoader.load(o);return this.textureLoader.setPath(c),l},parseMaterials:function(t){var r=new Map;if("Material"in e.Objects){var n=e.Objects.Material;for(var o in n){var l=this.parseMaterial(n[o],t);null!==l&&r.set(parseInt(o),l)}}return r},parseMaterial:function(e,r){var o=e.id,l=e.attrName,c=e.ShadingModel;if("object"==typeof c&&(c=c.value),!t.has(o))return null;var h,f=this.parseParameters(e,r,o);switch(c.toLowerCase()){case"phong":h=new n.z;break;case"lambert":h=new n.y;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',c),h=new n.z}return h.setValues(f),h.name=l,h},parseParameters:function(e,r,o){var l={};e.BumpFactor&&(l.bumpScale=e.BumpFactor.value),e.Diffuse?l.color=(new n.g).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(l.color=(new n.g).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(l.displacementScale=e.DisplacementFactor.value),e.Emissive?l.emissive=(new n.g).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(l.emissive=(new n.g).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(l.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(l.opacity=parseFloat(e.Opacity.value)),l.opacity<1&&(l.transparent=!0),e.ReflectionFactor&&(l.reflectivity=e.ReflectionFactor.value),e.Shininess&&(l.shininess=e.Shininess.value),e.Specular?l.specular=(new n.g).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(l.specular=(new n.g).fromArray(e.SpecularColor.value));var c=this;return t.get(o).children.forEach((function(e){var t=e.relationship;switch(t){case"Bump":l.bumpMap=c.getTexture(r,e.ID);break;case"Maya|TEX_ao_map":l.aoMap=c.getTexture(r,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":l.map=c.getTexture(r,e.ID),l.map.encoding=n.Z;break;case"DisplacementColor":l.displacementMap=c.getTexture(r,e.ID);break;case"EmissiveColor":l.emissiveMap=c.getTexture(r,e.ID),l.emissiveMap.encoding=n.Z;break;case"NormalMap":case"Maya|TEX_normal_map":l.normalMap=c.getTexture(r,e.ID);break;case"ReflectionColor":l.envMap=c.getTexture(r,e.ID),l.envMap.mapping=n.j,l.envMap.encoding=n.Z;break;case"SpecularColor":l.specularMap=c.getTexture(r,e.ID),l.specularMap.encoding=n.Z;break;case"TransparentColor":l.alphaMap=c.getTexture(r,e.ID),l.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",t)}})),l},getTexture:function(r,n){return"LayeredTexture"in e.Objects&&n in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),n=t.get(n).children[0].ID),r.get(n)},parseDeformers:function(){var r={},n={};if("Deformer"in e.Objects){var o=e.Objects.Deformer;for(var l in o){var c=o[l],h=t.get(parseInt(l));if("Skin"===c.attrType){var f=this.parseSkeleton(h,o);f.ID=l,h.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),f.geometryID=h.parents[0].ID,r[l]=f}else if("BlendShape"===c.attrType){var v={id:l};v.rawTargets=this.parseMorphTargets(h,o),v.id=l,h.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),n[l]=v}}}return{skeletons:r,morphTargets:n}},parseSkeleton:function(e,t){var r=[];return e.children.forEach((function(e){var o=t[e.ID];if("Cluster"===o.attrType){var l={ID:e.ID,indices:[],weights:[],transformLink:(new n.w).fromArray(o.TransformLink.a)};"Indexes"in o&&(l.indices=o.Indexes.a,l.weights=o.Weights.a),r.push(l)}})),{rawBones:r,bones:[]}},parseMorphTargets:function(e,r){for(var n=[],i=0;i<e.children.length;i++){var o=e.children[i],l=r[o.ID],c={name:l.attrName,initialWeight:l.DeformPercent,id:l.id,fullWeights:l.FullWeights.a};if("BlendShapeChannel"!==l.attrType)return;c.geoID=t.get(parseInt(o.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(c)}return n},parseScene:function(o,l,c){r=new n.o;var f=this.parseModels(o.skeletons,l,c),v=e.Objects.Model,d=this;f.forEach((function(e){var n=v[e.ID];d.setLookAtProperties(e,n),t.get(e.ID).parents.forEach((function(t){var r=f.get(t.ID);void 0!==r&&r.add(e)})),null===e.parent&&r.add(e)})),this.bindSkeleton(o.skeletons,l,f),this.createAmbientLight(),this.setupMorphMaterials(),r.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrixWorld=e.parent.matrix);var t=k(e.userData.transformData);e.applyMatrix4(t)}}));var m=(new h).parse();1===r.children.length&&r.children[0].isGroup&&(r.children[0].animations=m,r=r.children[0]),r.animations=m},parseModels:function(r,o,l){var c=new Map,h=e.Objects.Model;for(var f in h){var v=parseInt(f),d=h[f],m=t.get(v),y=this.buildSkeleton(m,r,v,d.attrName);if(!y){switch(d.attrType){case"Camera":y=this.createCamera(m);break;case"Light":y=this.createLight(m);break;case"Mesh":y=this.createMesh(m,o,l);break;case"NurbsCurve":y=this.createCurve(m,o);break;case"LimbNode":case"Root":y=new n.c;break;case"Null":default:y=new n.o}y.name=d.attrName?n.G.sanitizeNodeName(d.attrName):"",y.ID=v}this.getTransformData(y,d),c.set(v,y)}return c},buildSkeleton:function(e,t,r,o){var l=null;return e.parents.forEach((function(e){for(var c in t){var h=t[c];h.rawBones.forEach((function(t,i){if(t.ID===e.ID){var c=l;(l=new n.c).matrixWorld.copy(t.transformLink),l.name=o?n.G.sanitizeNodeName(o):"",l.ID=r,h.bones[i]=l,null!==c&&l.add(c)}}))}})),l},createCamera:function(t){var r,o;if(t.children.forEach((function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(o=r)})),void 0===o)r=new n.B;else{var l=0;void 0!==o.CameraProjectionType&&1===o.CameraProjectionType.value&&(l=1);var c=1;void 0!==o.NearPlane&&(c=o.NearPlane.value/1e3);var h=1e3;void 0!==o.FarPlane&&(h=o.FarPlane.value/1e3);var f=window.innerWidth,v=window.innerHeight;void 0!==o.AspectWidth&&void 0!==o.AspectHeight&&(f=o.AspectWidth.value,v=o.AspectHeight.value);var d=f/v,m=45;void 0!==o.FieldOfView&&(m=o.FieldOfView.value);var y=o.FocalLength?o.FocalLength.value:null;switch(l){case 0:r=new n.D(m,d,c,h),null!==y&&r.setFocalLength(y);break;case 1:r=new n.C(-f/2,f/2,v/2,-v/2,c,h);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+l+"."),r=new n.B}}return r},createLight:function(t){var r,o;if(t.children.forEach((function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(o=r)})),void 0===o)r=new n.B;else{var l;l=void 0===o.LightType?0:o.LightType.value;var c=16777215;void 0!==o.Color&&(c=(new n.g).fromArray(o.Color.value));var h=void 0===o.Intensity?1:o.Intensity.value/100;void 0!==o.CastLightOnObject&&0===o.CastLightOnObject.value&&(h=0);var f=0;void 0!==o.FarAttenuationEnd&&(f=void 0!==o.EnableFarAttenuation&&0===o.EnableFarAttenuation.value?0:o.FarAttenuationEnd.value);switch(l){case 0:r=new n.F(c,h,f,1);break;case 1:r=new n.i(c,h);break;case 2:var v=Math.PI/3;void 0!==o.InnerAngle&&(v=n.u.degToRad(o.InnerAngle.value));var d=0;void 0!==o.OuterAngle&&(d=n.u.degToRad(o.OuterAngle.value),d=Math.max(d,1)),r=new n.P(c,h,f,v,d,1);break;default:console.warn("THREE.FBXLoader: Unknown light type "+o.LightType.value+", defaulting to a PointLight."),r=new n.F(c,h)}void 0!==o.CastShadows&&1===o.CastShadows.value&&(r.castShadow=!0)}return r},createMesh:function(e,t,r){var o,l=null,c=null,h=[];return e.children.forEach((function(e){t.has(e.ID)&&(l=t.get(e.ID)),r.has(e.ID)&&h.push(r.get(e.ID))})),h.length>1?c=h:h.length>0?c=h[0]:(c=new n.z({color:13421772}),h.push(c)),"color"in l.attributes&&h.forEach((function(e){e.vertexColors=!0})),l.FBX_Deformer?(h.forEach((function(e){e.skinning=!0})),(o=new n.N(l,c)).normalizeSkinWeights()):o=new n.x(l,c),o},createCurve:function(e,t){var r=e.children.reduce((function(e,r){return t.has(r.ID)&&(e=t.get(r.ID)),e}),null),o=new n.q({color:3342591,linewidth:1});return new n.p(r,o)},getTransformData:function(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),r.eulerOrder="RotationOrder"in t?E(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r},setLookAtProperties:function(o,l){"LookAtProperty"in l&&t.get(o.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){var l=e.Objects.Model[t.ID];if("Lcl_Translation"in l){var c=l.Lcl_Translation.value;void 0!==o.target?(o.target.position.fromArray(c),r.add(o.target)):o.lookAt((new n.V).fromArray(c))}}}))},bindSkeleton:function(e,r,o){var l=this.parsePoseNodes();for(var c in e){var h=e[c];t.get(parseInt(h.ID)).parents.forEach((function(e){if(r.has(e.ID)){var c=e.ID;t.get(c).parents.forEach((function(e){o.has(e.ID)&&o.get(e.ID).bind(new n.M(h.bones),l[e.ID])}))}}))}},parsePoseNodes:function(){var t={};if("Pose"in e.Objects){var r=e.Objects.Pose;for(var o in r)if("BindPose"===r[o].attrType){var l=r[o].PoseNode;Array.isArray(l)?l.forEach((function(e){t[e.Node]=(new n.w).fromArray(e.Matrix.a)})):t[l.Node]=(new n.w).fromArray(l.Matrix.a)}}return t},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var t=e.GlobalSettings.AmbientColor.value,o=t[0],g=t[1],b=t[2];if(0!==o||0!==g||0!==b){var l=new n.g(o,g,b);r.add(new n.a(l,1))}}},setupMorphMaterials:function(){var e=this;r.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(r,i){e.setupMorphMaterial(t,r,i)})):e.setupMorphMaterial(t,t.material))}))},setupMorphMaterial:function(e,t,n){var o=e.uuid,l=t.uuid,c=!1;if(r.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===l&&e.uuid!==o&&(c=!0)})):e.material.uuid===l&&e.uuid!==o&&(c=!0))})),!0===c){var h=t.clone();h.morphTargets=!0,void 0===n?e.material=h:e.material[n]=h}else t.morphTargets=!0}},c.prototype={constructor:c,parse:function(r){var n=new Map;if("Geometry"in e.Objects){var o=e.Objects.Geometry;for(var l in o){var c=t.get(parseInt(l)),h=this.parseGeometry(c,o[l],r);n.set(parseInt(l),h)}}return n},parseGeometry:function(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(t,r,n){var o=n.skeletons,l=[],c=t.parents.map((function(t){return e.Objects.Model[t.ID]}));if(0!==c.length){var h=t.children.reduce((function(e,t){return void 0!==o[t.ID]&&(e=o[t.ID]),e}),null);t.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&l.push(n.morphTargets[e.ID])}));var f=c[0],v={};"RotationOrder"in f&&(v.eulerOrder=E(f.RotationOrder.value)),"InheritType"in f&&(v.inheritType=parseInt(f.InheritType.value)),"GeometricTranslation"in f&&(v.translation=f.GeometricTranslation.value),"GeometricRotation"in f&&(v.rotation=f.GeometricRotation.value),"GeometricScaling"in f&&(v.scale=f.GeometricScaling.value);var d=k(v);return this.genGeometry(r,h,l,d)}},genGeometry:function(e,t,r,o){var l=new n.e;e.attrName&&(l.name=e.attrName);var c=this.parseGeoNode(e,t),h=this.genBuffers(c),f=new n.n(h.vertex,3);if(f.applyMatrix4(o),l.setAttribute("position",f),h.colors.length>0&&l.setAttribute("color",new n.n(h.colors,3)),t&&(l.setAttribute("skinIndex",new n.T(h.weightsIndices,4)),l.setAttribute("skinWeight",new n.n(h.vertexWeights,4)),l.FBX_Deformer=t),h.normal.length>0){var v=(new n.v).getNormalMatrix(o),d=new n.n(h.normal,3);d.applyNormalMatrix(v),l.setAttribute("normal",d)}if(h.uvs.forEach((function(e,i){var t="uv"+(i+1).toString();0===i&&(t="uv"),l.setAttribute(t,new n.n(h.uvs[i],2))})),c.material&&"AllSame"!==c.material.mappingType){var m=h.materialIndex[0],y=0;if(h.materialIndex.forEach((function(e,i){e!==m&&(l.addGroup(y,i-y,m),m=e,y=i)})),l.groups.length>0){var w=l.groups[l.groups.length-1],I=w.start+w.count;I!==h.materialIndex.length&&l.addGroup(I,h.materialIndex.length-I,m)}0===l.groups.length&&l.addGroup(0,h.materialIndex.length,h.materialIndex[0])}return this.addMorphTargets(l,e,r,o),l},parseGeoNode:function(e,t){var r={};if(r.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],r.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];for(var i=0;e.LayerElementUV[i];)r.uv.push(this.parseUVs(e.LayerElementUV[i])),i++}return r.weightTable={},null!==t&&(r.skeleton=t,t.rawBones.forEach((function(e,i){e.indices.forEach((function(t,n){void 0===r.weightTable[t]&&(r.weightTable[t]=[]),r.weightTable[t].push({id:i,weight:e.weights[n]})}))}))),r},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,n=0,o=!1,l=[],c=[],h=[],f=[],v=[],d=[],m=this;return e.vertexIndices.forEach((function(y,w){var I=!1;y<0&&(y^=-1,I=!0);var x=[],A=[];if(l.push(3*y,3*y+1,3*y+2),e.color){var data=T(w,r,y,e.color);h.push(data[0],data[1],data[2])}if(e.skeleton){if(void 0!==e.weightTable[y]&&e.weightTable[y].forEach((function(e){A.push(e.weight),x.push(e.id)})),A.length>4){o||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),o=!0);var k=[0,0,0,0],E=[0,0,0,0];A.forEach((function(e,t){var r=e,n=x[t];E.forEach((function(e,t,o){if(r>e){o[t]=r,r=e;var l=k[t];k[t]=n,n=l}}))})),x=k,A=E}for(;A.length<4;)A.push(0),x.push(0);for(var i=0;i<4;++i)v.push(A[i]),d.push(x[i])}if(e.normal){data=T(w,r,y,e.normal);c.push(data[0],data[1],data[2])}if(e.material&&"AllSame"!==e.material.mappingType)var D=T(w,r,y,e.material)[0];e.uv&&e.uv.forEach((function(e,i){var data=T(w,r,y,e);void 0===f[i]&&(f[i]=[]),f[i].push(data[0]),f[i].push(data[1])})),n++,I&&(m.genFace(t,e,l,D,c,h,f,v,d,n),r++,n=0,l=[],c=[],h=[],f=[],v=[],d=[])})),t},genFace:function(e,t,r,n,o,l,c,h,f,v){for(var i=2;i<v;i++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[3*(i-1)]]),e.vertex.push(t.vertexPositions[r[3*(i-1)+1]]),e.vertex.push(t.vertexPositions[r[3*(i-1)+2]]),e.vertex.push(t.vertexPositions[r[3*i]]),e.vertex.push(t.vertexPositions[r[3*i+1]]),e.vertex.push(t.vertexPositions[r[3*i+2]]),t.skeleton&&(e.vertexWeights.push(h[0]),e.vertexWeights.push(h[1]),e.vertexWeights.push(h[2]),e.vertexWeights.push(h[3]),e.vertexWeights.push(h[4*(i-1)]),e.vertexWeights.push(h[4*(i-1)+1]),e.vertexWeights.push(h[4*(i-1)+2]),e.vertexWeights.push(h[4*(i-1)+3]),e.vertexWeights.push(h[4*i]),e.vertexWeights.push(h[4*i+1]),e.vertexWeights.push(h[4*i+2]),e.vertexWeights.push(h[4*i+3]),e.weightsIndices.push(f[0]),e.weightsIndices.push(f[1]),e.weightsIndices.push(f[2]),e.weightsIndices.push(f[3]),e.weightsIndices.push(f[4*(i-1)]),e.weightsIndices.push(f[4*(i-1)+1]),e.weightsIndices.push(f[4*(i-1)+2]),e.weightsIndices.push(f[4*(i-1)+3]),e.weightsIndices.push(f[4*i]),e.weightsIndices.push(f[4*i+1]),e.weightsIndices.push(f[4*i+2]),e.weightsIndices.push(f[4*i+3])),t.color&&(e.colors.push(l[0]),e.colors.push(l[1]),e.colors.push(l[2]),e.colors.push(l[3*(i-1)]),e.colors.push(l[3*(i-1)+1]),e.colors.push(l[3*(i-1)+2]),e.colors.push(l[3*i]),e.colors.push(l[3*i+1]),e.colors.push(l[3*i+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(o[0]),e.normal.push(o[1]),e.normal.push(o[2]),e.normal.push(o[3*(i-1)]),e.normal.push(o[3*(i-1)+1]),e.normal.push(o[3*(i-1)+2]),e.normal.push(o[3*i]),e.normal.push(o[3*i+1]),e.normal.push(o[3*i+2])),t.uv&&t.uv.forEach((function(t,r){void 0===e.uvs[r]&&(e.uvs[r]=[]),e.uvs[r].push(c[r][0]),e.uvs[r].push(c[r][1]),e.uvs[r].push(c[r][2*(i-1)]),e.uvs[r].push(c[r][2*(i-1)+1]),e.uvs[r].push(c[r][2*i]),e.uvs[r].push(c[r][2*i+1])}))},addMorphTargets:function(t,r,n,o){if(0!==n.length){t.morphTargetsRelative=!0,t.morphAttributes.position=[];var l=this;n.forEach((function(n){n.rawTargets.forEach((function(n){var c=e.Objects.Geometry[n.geoID];void 0!==c&&l.genMorphGeometry(t,r,c,o,n.name)}))}))}},genMorphGeometry:function(e,t,r,o,l){for(var c=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],h=void 0!==r.Vertices?r.Vertices.a:[],f=void 0!==r.Indexes?r.Indexes.a:[],v=3*e.attributes.position.count,d=new Float32Array(v),i=0;i<f.length;i++){var m=3*f[i];d[m]=h[3*i],d[m+1]=h[3*i+1],d[m+2]=h[3*i+2]}var y={vertexIndices:c,vertexPositions:d},w=this.genBuffers(y),I=new n.n(w.vertex,3);I.name=l||r.attrName,I.applyMatrix4(o),e.morphAttributes.position.push(I)},parseNormals:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Normals.a,o=[];return"IndexToDirect"===r&&("NormalIndex"in e?o=e.NormalIndex.a:"NormalsIndex"in e&&(o=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:o,mappingType:t,referenceType:r}},parseUVs:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.UV.a,o=[];return"IndexToDirect"===r&&(o=e.UVIndex.a),{dataSize:2,buffer:n,indices:o,mappingType:t,referenceType:r}},parseVertexColors:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Colors.a,o=[];return"IndexToDirect"===r&&(o=e.ColorIndex.a),{dataSize:4,buffer:n,indices:o,mappingType:t,referenceType:r}},parseMaterialIndices:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var n=e.Materials.a,o=[],i=0;i<n.length;++i)o.push(i);return{dataSize:1,buffer:n,indices:o,mappingType:t,referenceType:r}},parseNurbsGeometry:function(e){if(void 0===Y)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new n.e;var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new n.e;for(var r,o,l=t-1,c=e.KnotVector.a,h=[],f=e.Points.a,i=0,v=f.length;i<v;i+=4)h.push((new n.W).fromArray(f,i));if("Closed"===e.Form)h.push(h[0]);else if("Periodic"===e.Form){r=l,o=c.length-1-r;for(i=0;i<l;++i)h.push(h[i])}var d=new Y(l,c,h,r,o).getPoints(7*h.length),m=new Float32Array(3*d.length);d.forEach((function(e,i){e.toArray(m,3*i)}));var y=new n.e;return y.setAttribute("position",new n.d(m,3)),y}},h.prototype={constructor:h,parse:function(){var e=[],t=this.parseClips();if(void 0!==t)for(var r in t){var n=t[r],o=this.addClip(n);e.push(o)}return e},parseClips:function(){if(void 0!==e.Objects.AnimationCurve){var t=this.parseAnimationCurveNodes();this.parseAnimationCurves(t);var r=this.parseAnimationLayers(t);return this.parseAnimStacks(r)}},parseAnimationCurveNodes:function(){var t=e.Objects.AnimationCurveNode,r=new Map;for(var n in t){var o=t[n];if(null!==o.attrName.match(/S|R|T|DeformPercent/)){var l={id:o.id,attr:o.attrName,curves:{}};r.set(l.id,l)}}return r},parseAnimationCurves:function(r){var n=e.Objects.AnimationCurve;for(var o in n){var l={id:n[o].id,times:n[o].KeyTime.a.map(w),values:n[o].KeyValueFloat.a},c=t.get(l.id);if(void 0!==c){var h=c.parents[0].ID,f=c.parents[0].relationship;f.match(/X/)?r.get(h).curves.x=l:f.match(/Y/)?r.get(h).curves.y=l:f.match(/Z/)?r.get(h).curves.z=l:f.match(/d|DeformPercent/)&&r.has(h)&&(r.get(h).curves.morph=l)}}},parseAnimationLayers:function(o){var l=e.Objects.AnimationLayer,c=new Map;for(var h in l){var f=[],v=t.get(parseInt(h));if(void 0!==v)v.children.forEach((function(l,i){if(o.has(l.ID)){var c=o.get(l.ID);if(void 0!==c.curves.x||void 0!==c.curves.y||void 0!==c.curves.z){if(void 0===f[i])if(void 0!==(w=t.get(l.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID)){var h={modelName:(v=e.Objects.Model[w.toString()]).attrName?n.G.sanitizeNodeName(v.attrName):"",ID:v.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};r.traverse((function(e){e.ID===v.id&&(h.transform=e.matrix,e.userData.transformData&&(h.eulerOrder=e.userData.transformData.eulerOrder))})),h.transform||(h.transform=new n.w),"PreRotation"in v&&(h.preRotation=v.PreRotation.value),"PostRotation"in v&&(h.postRotation=v.PostRotation.value),f[i]=h}f[i]&&(f[i][c.attr]=c)}else if(void 0!==c.curves.morph){if(void 0===f[i]){var v,d=t.get(l.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,m=t.get(d).parents[0].ID,y=t.get(m).parents[0].ID,w=t.get(y).parents[0].ID;h={modelName:(v=e.Objects.Model[w]).attrName?n.G.sanitizeNodeName(v.attrName):"",morphName:e.Objects.Deformer[d].attrName};f[i]=h}f[i][c.attr]=c}}})),c.set(parseInt(h),f)}return c},parseAnimStacks:function(r){var n=e.Objects.AnimationStack,o={};for(var l in n){var c=t.get(parseInt(l)).children;c.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var h=r.get(c[0].ID);o[l]={name:n[l].attrName,layer:h}}return o},addClip:function(e){var t=[],r=this;return e.layer.forEach((function(e){t=t.concat(r.generateTracks(e))})),new n.b(e.name,-1,t)},generateTracks:function(e){var t=[],r=new n.V,o=new n.H,l=new n.V;if(e.transform&&e.transform.decompose(r,o,l),r=r.toArray(),o=(new n.k).setFromQuaternion(o,e.eulerOrder).toArray(),l=l.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){var c=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");void 0!==c&&t.push(c)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){var h=this.generateRotationTrack(e.modelName,e.R.curves,o,e.preRotation,e.postRotation,e.eulerOrder);void 0!==h&&t.push(h)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){var f=this.generateVectorTrack(e.modelName,e.S.curves,l,"scale");void 0!==f&&t.push(f)}if(void 0!==e.DeformPercent){var v=this.generateMorphTrack(e);void 0!==v&&t.push(v)}return t},generateVectorTrack:function(e,t,r,o){var l=this.getTimesForAllAxes(t),c=this.getKeyframeTrackValues(l,t,r);return new n.X(e+"."+o,l,c)},generateRotationTrack:function(e,t,r,o,l,c){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(n.u.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(n.u.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(n.u.degToRad));var h=this.getTimesForAllAxes(t),f=this.getKeyframeTrackValues(h,t,r);void 0!==o&&((o=o.map(n.u.degToRad)).push(c),o=(new n.k).fromArray(o),o=(new n.H).setFromEuler(o)),void 0!==l&&((l=l.map(n.u.degToRad)).push(c),l=(new n.k).fromArray(l),l=(new n.H).setFromEuler(l).inverse());for(var v=new n.H,d=new n.k,m=[],i=0;i<f.length;i+=3)d.set(f[i],f[i+1],f[i+2],c),v.setFromEuler(d),void 0!==o&&v.premultiply(o),void 0!==l&&v.multiply(l),v.toArray(m,i/3*4);return new n.I(e+".quaternion",h,m)},generateMorphTrack:function(e){var t=e.DeformPercent.curves.morph,o=t.values.map((function(e){return e/100})),l=r.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new n.A(e.modelName+".morphTargetInfluences["+l+"]",t.times,o)},getTimesForAllAxes:function(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(a,b){return a-b})).filter((function(e,t,r){return r.indexOf(e)==t}))},getKeyframeTrackValues:function(e,t,r){var n=r,o=[],l=-1,c=-1,h=-1;return e.forEach((function(time){if(t.x&&(l=t.x.times.indexOf(time)),t.y&&(c=t.y.times.indexOf(time)),t.z&&(h=t.z.times.indexOf(time)),-1!==l){var e=t.x.values[l];o.push(e),n[0]=e}else o.push(n[0]);if(-1!==c){var r=t.y.values[c];o.push(r),n[1]=r}else o.push(n[1]);if(-1!==h){var f=t.z.values[h];o.push(f),n[2]=f}else o.push(n[2])})),o},interpolateRotations:function(e){for(var i=1;i<e.values.length;i++){var t=e.values[i-1],r=e.values[i]-t,n=Math.abs(r);if(n>=180){for(var o=n/180,l=r/o,c=t+l,h=e.times[i-1],f=(e.times[i]-h)/o,v=h+f,d=[],m=[];v<e.times[i];)d.push(v),v+=f,m.push(c),c+=l;e.times=N(e.times,i,d),e.values=N(e.values,i,m)}}}},f.prototype={constructor:f,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(text){this.currentIndent=0,this.allNodes=new m,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var e=this,t=text.split(/[\r\n]+/);return t.forEach((function(line,i){var r=line.match(/^[\s\t]*;/),n=line.match(/^[\s\t]*$/);if(!r&&!n){var o=line.match("^\\t{"+e.currentIndent+"}(\\w+):(.*){",""),l=line.match("^\\t{"+e.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),c=line.match("^\\t{"+(e.currentIndent-1)+"}}");o?e.parseNodeBegin(line,o):l?e.parseNodeProperty(line,l,t[++i]):c?e.popStack():line.match(/^[^\s\t}]/)&&e.parseNodePropertyContinued(line)}})),this.allNodes},parseNodeBegin:function(line,e){var t=e[1].trim().replace(/^"/,"").replace(/"$/,""),r=e[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),n={name:t},o=this.parseNodeAttr(r),l=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(t,n):t in l?("PoseNode"===t?l.PoseNode.push(n):void 0!==l[t].id&&(l[t]={},l[t][l[t].id]=l[t]),""!==o.id&&(l[t][o.id]=n)):"number"==typeof o.id?(l[t]={},l[t][o.id]=n):"Properties70"!==t&&(l[t]="PoseNode"===t?[n]:n),"number"==typeof o.id&&(n.id=o.id),""!==o.name&&(n.attrName=o.name),""!==o.type&&(n.attrType=o.type),this.pushStack(n)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",n="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:r,type:n}},parseNodeProperty:function(line,e,t){var r=e[1].replace(/^"/,"").replace(/"$/,"").trim(),n=e[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===n&&(n=t.replace(/"/g,"").replace(/,$/,"").trim());var o=this.getCurrentNode();if("Properties70"!==o.name){if("C"===r){var l=n.split(",").slice(1),c=parseInt(l[0]),h=parseInt(l[1]),f=n.split(",").slice(3);r="connections",function(a,b){for(var i=0,e=a.length,t=b.length;i<t;i++,e++)a[e]=b[i]}(n=[c,h],f=f.map((function(e){return e.trim().replace(/^"/,"")}))),void 0===o[r]&&(o[r]=[])}"Node"===r&&(o.id=n),r in o&&Array.isArray(o[r])?o[r].push(n):"a"!==r?o[r]=n:o.a=n,this.setCurrentProp(o,r),"a"===r&&","!==n.slice(-1)&&(o.a=D(n))}else this.parseNodeSpecialProperty(line,r,n)},parseNodePropertyContinued:function(line){var e=this.getCurrentNode();e.a+=line,","!==line.slice(-1)&&(e.a=D(e.a))},parseNodeSpecialProperty:function(line,e,t){var r=t.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),n=r[0],o=r[1],l=r[2],c=r[3],h=r[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":h=parseFloat(h);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":h=D(h)}this.getPrevNode()[n]={type:o,type2:l,flag:c,value:h},this.setCurrentProp(this.getPrevNode(),n)}},v.prototype={constructor:v,parse:function(e){var t=new d(e);t.skip(23);var r=t.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+r);for(var n=new m;!this.endOfContent(t);){var o=this.parseNode(t,r);null!==o&&n.add(o.name,o)}return n},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},n=t>=7500?e.getUint64():e.getUint32(),o=t>=7500?e.getUint64():e.getUint32(),l=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),c=e.getString(l);if(0===n)return null;for(var h=[],i=0;i<o;i++)h.push(this.parseProperty(e));var f=h.length>0?h[0]:"",v=h.length>1?h[1]:"",d=h.length>2?h[2]:"";for(r.singleProperty=1===o&&e.getOffset()===n;n>e.getOffset();){var m=this.parseNode(e,t);null!==m&&this.parseSubNode(c,r,m)}return r.propertyList=h,"number"==typeof f&&(r.id=f),""!==v&&(r.attrName=v),""!==d&&(r.attrType=d),""!==c&&(r.name=c),r},parseSubNode:function(e,t,r){if(!0===r.singleProperty){var n=r.propertyList[0];Array.isArray(n)?(t[r.name]=r,r.a=n):t[r.name]=n}else if("Connections"===e&&"C"===r.name){var o=[];r.propertyList.forEach((function(e,i){0!==i&&o.push(e)})),void 0===t.connections&&(t.connections=[]),t.connections.push(o)}else if("Properties70"===r.name){Object.keys(r).forEach((function(e){t[e]=r[e]}))}else if("Properties70"===e&&"P"===r.name){var l,c=r.propertyList[0],h=r.propertyList[1],f=r.propertyList[2],v=r.propertyList[3];0===c.indexOf("Lcl ")&&(c=c.replace("Lcl ","Lcl_")),0===h.indexOf("Lcl ")&&(h=h.replace("Lcl ","Lcl_")),l="Color"===h||"ColorRGB"===h||"Vector"===h||"Vector3D"===h||0===h.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[c]={type:h,type2:f,flag:v,value:l}}else void 0===t[r.name]?"number"==typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var r=e.getUint32();return e.getArrayBuffer(r);case"S":r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),o=e.getUint32(),l=e.getUint32();if(0===o)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}void 0===Z&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var c=new d(new Z.Inflate(new Uint8Array(e.getArrayBuffer(l))).decompress().buffer);switch(t){case"b":case"c":return c.getBooleanArray(n);case"d":return c.getFloat64Array(n);case"f":return c.getFloat32Array(n);case"i":return c.getInt32Array(n);case"l":return c.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}},d.prototype={constructor:d,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getBoolean());return a},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getInt32());return a},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getInt64());return a},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getFloat32());return a},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getFloat64());return a},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var a=[],i=0;i<e;i++)a[i]=this.getUint8();var t=a.indexOf(0);return t>=0&&(a=a.slice(0,t)),n.s.decodeText(new Uint8Array(a))}},m.prototype={constructor:m,add:function(e,t){this[e]=t}};var I=[];function T(e,t,r,n){var o;switch(n.mappingType){case"ByPolygonVertex":o=e;break;case"ByPolygon":o=t;break;case"ByVertice":o=r;break;case"AllSame":o=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}"IndexToDirect"===n.referenceType&&(o=n.indices[o]);var l=o*n.dataSize,c=l+n.dataSize;return function(a,b,e,t){for(var i=e,r=0;i<t;i++,r++)a[r]=b[i];return a}(I,n.buffer,l,c)}var x=new n.k,A=new n.V;function k(e){var t,r=new n.w,o=new n.w,l=new n.w,c=new n.w,h=new n.w,f=new n.w,v=new n.w,d=new n.w,m=new n.w,y=new n.w,w=new n.w,I=e.inheritType?e.inheritType:0;(e.translation&&r.setPosition(A.fromArray(e.translation)),e.preRotation)&&((t=e.preRotation.map(n.u.degToRad)).push(e.eulerOrder),o.makeRotationFromEuler(x.fromArray(t)));e.rotation&&((t=e.rotation.map(n.u.degToRad)).push(e.eulerOrder),l.makeRotationFromEuler(x.fromArray(t)));e.postRotation&&((t=e.postRotation.map(n.u.degToRad)).push(e.eulerOrder),c.makeRotationFromEuler(x.fromArray(t)));e.scale&&h.scale(A.fromArray(e.scale)),e.scalingOffset&&v.setPosition(A.fromArray(e.scalingOffset)),e.scalingPivot&&f.setPosition(A.fromArray(e.scalingPivot)),e.rotationOffset&&d.setPosition(A.fromArray(e.rotationOffset)),e.rotationPivot&&m.setPosition(A.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(y=e.parentMatrixWorld);var T=o.multiply(l).multiply(c),k=new n.w;y.extractRotation(k);var E,D,P,N,S=new n.w;if(S.copyPosition(y),P=S.getInverse(S).multiply(y),D=k.getInverse(k).multiply(P),E=h,0===I)N=k.multiply(T).multiply(D).multiply(E);else if(1===I)N=k.multiply(D).multiply(T).multiply(E);else{var L=(new n.w).copy(h),F=D.multiply(L.getInverse(L));N=k.multiply(T).multiply(F).multiply(E)}var R=r.multiply(d).multiply(m).multiply(o).multiply(l).multiply(c).multiply(m.getInverse(m)).multiply(v).multiply(f).multiply(h).multiply(f.getInverse(f)),C=(new n.w).copyPosition(R),O=y.multiply(C);return w.copyPosition(O),R=w.multiply(N)}function E(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function D(e){return e.split(",").map((function(e){return parseFloat(e)}))}function P(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=e.byteLength),n.s.decodeText(new Uint8Array(e,t,r))}function N(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}return o}()}}]);